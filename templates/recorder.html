{% load staticfiles %}

<!DOCTYPE html>

<html>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<head>
    <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="{% static 'js/recorder.js' %}"></script>
    <script src="{% static 'js/upload.js' %}"></script>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  

	<title>Live input record and playback</title>
  <style type='text/css'>
  @import url(//fonts.googleapis.com/earlyaccess/notosanskannada.css);
  .content{
    font-family: 'Noto Sans Kannada', sans-serif;
  }
    
  recordingslist audio {}
  </style>
</head>

<body >


<div style="margin-left:50%">
<h1 id="textHead" class=" w3-button  w3-border  w3-hover-teal w3-border-blue w3-margin"><b>完整文本<i class="fa fa-angle-double-down" style="font-size:36px"></i><h5>點擊可隱藏或顯示</h5></h1>
<div class="w3-table-all w3-hoverable w3-xlarge">
  <table  class="w3-bordered-red w3-black w3-text-black " id="theTable" style="width: 100%" >
    <tr><td>編號</td><td>台語</td><td>中文意思</td></tr>
  </table>
</div>

<h2 class=" w3-button w3-border  w3-hover-teal w3-border-blue w3-margin"><b>您錄製的內容</h2>
  <ul id="recordingslist"></ul>

</div>

  



<div class="w3-sidebar w3-bar-block w3-display-right w3-large w3-center content" style="width:50%;left:0">
  <div class="w3-container  w3-large w3-teal w3-text-black content" >
  <p>感謝幫忙錄製以下台語內容</p>
  <p>可以挑會唸的錄製即可，錄完可至文本下方檢查或挑選檔案</p>
  <p>提供音檔上傳麻煩請使用"錄1秒自動停止"</p>
  </div>
  <p class="w3-xlarge">您的暱稱為<b> {{ rlt }}</p>

  <div class="w3-panel w3-border-top w3-border-bottom w3-border-green">
  <div class="w3-xlarge">正在錄製的字:</div>
  
  <p class="w3-xxlarge" id="wordlist">一</p>
  </div>
 <div class="w3-show-inline-block  ">
  <button type="button" class="w3-btn w3-black w3-round-xxlarge" onclick="preword(this);" id="preword">上一個詞</button>
  <button type="button" class="w3-btn w3-black w3-round-xxlarge" onclick="nextword(this);" id="nextword">下一個詞</button>
  </div>
  <span  disabled="disabled"  tyle="DISPLAY:none" id="stopStart"></span>
  <div class="w3-show-inline-block  ">
  <button type="button" class="w3-btn w3-blue w3-round-xxlarge w3-green " onclick="startRecording(this);" id="startRecording">錄</button>
  <button type="button" class="w3-button w3-light-blue w3-round-xxlarge w3-black" onclick="startRecording_autostop(this) ;" id="startRecording_autostop">錄1秒自動停止</button>
  
  </div>
    <div id="div1" class="w3-text-red w3-xlarge" style="display:none">
    <i class="material-icons" style="font-size:25px;color:red">mic_none</i>
      錄音中...
  </div>

  
  <div class="w3-border w3-margin w3-large">
  <p>您的錄音有可能的結果<br>(根據機率大到小由左至右排列) <div id="recogResult" class="w3-xlarge w3-text-green"><b>開始錄音之後會在這為您顯示有可能的辨識結果</b></div></p>  
  </div>
  
  
  
  <h2>紀錄</h2>
  <pre id="log"></pre>

</body>
  <script>
  

  var audio_context;
  var recorder;
  var words = ['一','二','三','四','五','六','七','八','九','零','後退','前進','上','下','左','右','床','去','快樂','房屋','樹','鳥','貓','狗','志明','春嬌','可以','不可','開','關'];
  var originWords = ['一','二','三','四','五','六','七','八','九','零','退後','進前','起去','落來','倒邊','正邊','眠床','去','快樂','厝','樹','鳥','貓','狗','志明','春嬌','會使','袂使','開','關'];
  var words_th = 0;
  var result="";
  window.onload=makeTable();
  function makeTable(){
    
    var wordsLen=words.length;
    var tableString;
    var originTable
    for(var i=0;i<wordsLen;i++){
      originTable=document.getElementById("theTable").innerHTML;
      document.getElementById("theTable").innerHTML=originTable+"<tr><td id ='"+originWords[i]+"'>"+i+"</td><td>"+originWords[i]+"</td><td>"+words[i]+"</td></tr>";


    }
   
  }

  $(document).ready(function(){
    $("#theTable").slideToggle("fast");
    $("#textHead").click(function(){
        $("#theTable").slideToggle("fast");
    });
  });
  //////////////DDD//////////////
  function uploadAudioFromBlob_recog(blob) {
    var csrftoken = getCookie('csrftoken');

    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'uploadRecog_server', true);
    xhr.setRequestHeader("X-CSRFToken", csrftoken);
    xhr.setRequestHeader("MyCustomHeader", "Put anything you need in here, like an ID");

    xhr.upload.onloadend = function () {
       // alert(result);
        //alert('錄音成功');

    };

    xhr.send(blob);
    }
  

    
  //////////////DDD//////////////
      
  function __log(e, data) {
    log.innerHTML += "\n" + e + " " + (data || '');
  }

  function startUserMedia(stream) {
    var input = audio_context.createMediaStreamSource(stream);
    __log('媒體流已創建');

    // Uncomment if you want the audio to feedback directly
    //input.connect(audio_context.destination);
    //__log('Input connected to audio context destination.');
    
    recorder = new Recorder(input);
    __log('錄音機初始化');
  }

  function startRecording_autostop(button) {
    recorder && recorder.record();
    div1.style.display='';
    button.disabled = true;
    document.getElementById("preword").disabled = true;
    document.getElementById("nextword").disabled = true;
    document.getElementById("startRecording").disabled = true;
    __log('錄音中...');
    //1秒自動停止
    setTimeout("autostopRecording()",1000);
    //nextword();//下一個字
  }

  function autostopRecording() {
      recorder && recorder.stop();
      div1.style.display='none';
      document.getElementById("preword").disabled = false;
      document.getElementById("nextword").disabled = false;
      document.getElementById("startRecording").disabled = false;
      document.getElementById("startRecording_autostop").disabled = false;
      __log('停止錄音');
      createDownloadLink();
      recorder.clear();
      nextword();//下一個字
  }
  
  function startRecording(button) {
    $("#startRecording").css("display","none");//
    $("#stopRecording").css("display","block");//
    recorder && recorder.record();
    div1.style.display='';
    button.disabled = true;//false
    //button.value ='停';
    document.getElementById("preword").disabled = true;
    document.getElementById("nextword").disabled = true;
    //document.getElementById("stopRecording").disabled = false;
    document.getElementById("startRecording_autostop").disabled = true;
    __log('錄音中...');
    $("#stopStart").after("<button type='button' class='w3-btn w3-red w3-round-xxlarge' onclick='stopRecording(this);' id='stopRecording' >停</button>");
    $("#startRecording").remove();
  }

  function stopRecording(button) {
    $("#startRecording").css("display","block");//
    $("#stopRecording").css("display","none");//
    recorder && recorder.stop();
    div1.style.display='none';
    button.disabled = true;//false
    //button.value ='錄';
    document.getElementById("preword").disabled = false;
    document.getElementById("nextword").disabled = false;
    //document.getElementById("startRecording").disabled = false;
    document.getElementById("startRecording_autostop").disabled = false;
    __log('停止錄音');
    CreateDownloadLink();//no next
    recorder.clear();
     $("#stopStart").after("<button type='button' class='w3-btn w3-green  w3-round-xxlarge' onclick='startRecording(this);' id='startRecording'>錄</button>");
    $("#stopRecording").remove();
  }

  function preword() {
    var this_word = document.createElement("div");
    wordlist.removeChild(wordlist.childNodes[0]);
    if(words_th === 0)
        words_th = words.length - 1;
    else
        words_th = words_th - 1;
    this_word.innerHTML = words[words_th];
    wordlist.appendChild(this_word);
  }

  function nextword() {
    var this_word = document.createElement("div");
    wordlist.removeChild(wordlist.childNodes[0]);
    if(words_th === words.length - 1)
        words_th = 0;
    else
        words_th = words_th + 1;
    this_word.innerHTML = words[words_th];
    wordlist.appendChild(this_word);
  }

  function createDownloadLink() {
    recorder && recorder.exportWAV(function(blob) {
      var url = URL.createObjectURL(blob);
      var li = document.createElement('li');
      var au = document.createElement('audio');
      var hf = document.createElement('a');
      var download = document.createElement("button");
      var remove = document.createElement("button");
      var upload = document.createElement("button");
      var div = document.createElement("div");
      var word = document.createElement("div");
      var thisword = document.createElement("div");
      var theFirstChild = recordingslist.firstChild;
      var recog=document.createElement("li");

      $.ajax({
      url: 'recogResult',
      type: 'GET',
      error: function(xhr) {
        alert('Ajax request 發生錯誤');
      },
      success: function(response) {
          var recogResult=response;
          var wait="正在辨識中..."
          $('#recogResult').text(wait);
          setTimeout(3000)
          $('#recogResult').load('recogResult');
          
 
      }
    });
        
      //name of .wav file to use during upload and download (without extendion)
      var filename = new Date().toISOString();
      var recog=document.createElement("li");

      

      au.controls = true;
      au.src = url;
      hf.href = url;
      hf.download = filename + '.wav';
      hf.id = 'dl';
      hf.innerHTML = hf.download;
      word.innerHTML = "錄音內容: " + words[words_th-1];//-1
      thisword.innerHTML = words[words_th-1];//-1
      download.innerHTML = "下載"
      download.onclick = function(){
          filename = thisword.innerHTML + "_{{ rlt }}";
          hf.download = filename + '.wav';
          li.appendChild(hf)
          hf.click()
          li.removeChild(hf)
      };
      remove.innerHTML = "刪除";
      remove.onclick = function(){
          recordingslist.removeChild(li)
          recordingslist.removeChild(recog)
      };
      li.appendChild(word);
      li.appendChild(au);
      li.appendChild(download);
      li.appendChild(remove);
      div.innerHTML = "上傳成功";
      uploadAudioFromBlob_recog(blob);
      upload.innerHTML = "上傳";
      upload.onclick = function(){
          uploadword(thisword.innerHTML);
          uploadAudioFromBlob(blob);
          li.appendChild(div)
      };
      li.appendChild(upload);

      recordingslist.insertBefore(li,theFirstChild);
    });
  } 
      
      
/////////////////////////////////////////////////////////////////////////////////////no next
  
  function CreateDownloadLink() {
    recorder && recorder.exportWAV(function(blob) {
      var url = URL.createObjectURL(blob);
      var li = document.createElement('li');
      var au = document.createElement('audio');
      var hf = document.createElement('a');
      var download = document.createElement("button");
      var remove = document.createElement("button");
      var upload = document.createElement("button");
      var div = document.createElement("div");
      var word = document.createElement("div");
      var thisword = document.createElement("div");
      var theFirstChild = recordingslist.firstChild;
      var recog=document.createElement("li");

      $.ajax({
      url: 'recogResult',
      type: 'GET',
      error: function(xhr) {
        alert('Ajax request 發生錯誤');
      },
      success: function(response) {
          var recogResult=response;
          var wait="正在辨識中..."
          $('#recogResult').text(wait);
          setTimeout(3000)
          $('#recogResult').load('recogResult');
          
 
      }
    });
        
      //name of .wav file to use during upload and download (without extendion)
      var filename = new Date().toISOString();
      var recog=document.createElement("li");

      

      au.controls = true;
      au.src = url;
      hf.href = url;
      hf.download = filename + '.wav';
      hf.id = 'dl';
      hf.innerHTML = hf.download;
      word.innerHTML = "錄音內容: " + words[words_th];
      thisword.innerHTML = words[words_th];
      download.innerHTML = "下載"
      download.onclick = function(){
          filename = thisword.innerHTML + "_{{ rlt }}";
          hf.download = filename + '.wav';
          li.appendChild(hf)
          hf.click()
          li.removeChild(hf)
      };
      remove.innerHTML = "刪除";
      remove.onclick = function(){
          recordingslist.removeChild(li)
          recordingslist.removeChild(recog)
      };
      li.appendChild(word);
      li.appendChild(au);
      li.appendChild(download);
      li.appendChild(remove);
      div.innerHTML = "上傳成功";
      uploadAudioFromBlob_recog(blob);
      upload.innerHTML = "上傳";
      upload.onclick = function(){
          uploadword(thisword.innerHTML);
          uploadAudioFromBlob(blob);
          li.appendChild(div)
      };
      li.appendChild(upload);

      recordingslist.insertBefore(li,theFirstChild);
    });
      
      //nextword();//下一個字
  }
      
/////////////////////////////////////////////////////////////////////////////////////no next


  window.onload = function init() {
    try {
      // webkit shim
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia|| navigator.mozGetUserMedia || navigator.msGetUserMedia;
      window.URL = window.URL || window.webkitURL;

      audio_context = new AudioContext;
      __log('音頻文本設置');
      __log('navigator.getUserMedia ' + (navigator.getUserMedia ? '啟動' : '未啟動'));
    } catch (e) {
      alert('瀏覽器沒有音頻支援');
    }

    navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
      __log('No live audio input: ' + e);
    });
  };
  </script>


</body>
</html>
